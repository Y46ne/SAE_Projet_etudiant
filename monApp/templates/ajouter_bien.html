{% extends "base.html" %}

{% block title %}Ajouter un Bien{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='../static/css/ajouter_bien.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <main class="main-content">
        <header>
            <h1>Ajouter un Bien</h1>
            <p>Remplissez le formulaire ci-dessous pour enregistrer un nouveau bien.</p>
        </header>

        <section class="form-section">
            <div class="card">
                <form action="{{ url_for('ajouter_bien') }}" method="POST" enctype="multipart/form-data" class="form">
                    {% set target_piece_id = request.args.get('piece_id') %}
                    {% set ns = namespace(target_logement_id=None) %}
                    {% if target_piece_id %}
                        {% for p in liste_pieces %}
                            {% if p.id|string == target_piece_id|string %}{% set ns.target_logement_id = p.id_logement %}{% endif %}
                        {% endfor %}
                    {% endif %}

                    {{ form.hidden_tag() }}
                    
                    <div class="form-group {% if form.nom_bien.errors %}has-error{% endif %}">
                        {{ form.nom_bien.label(class="form-label") }}
                        {{ form.nom_bien(class="form-input", placeholder="Ex : Télévision 4K") }}
                        
                        {% if form.nom_bien.errors %}
                            {% for error in form.nom_bien.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="form-group {% if form.prix_achat.errors %}has-error{% endif %}">
                        {{ form.prix_achat.label(class="form-label") }}
                        {{ form.prix_achat(class="form-input", placeholder="Prix d'achat en €") }}
                        
                        {% if form.prix_achat.errors %}
                            {% for error in form.prix_achat.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                    </div>

                    <div class="form-group {% if form.categorie.errors %}has-error{% endif %}">
                        {{ form.categorie.label(class="form-label") }}
                        <select name="{{ form.categorie.name }}" id="{{ form.categorie.id }}" class="form-input" required>
                            <option value="" disabled selected>Sélectionner une catégorie</option>
                            <option value="Electromenager" {% if form.categorie.data == 'Electromenager' %}selected{% endif %}>Électroménager</option>
                            <option value="Mobilier" {% if form.categorie.data == 'Mobilier' %}selected{% endif %}>Mobilier</option>
                            <option value="Multimedia" {% if form.categorie.data == 'Multimedia' %}selected{% endif %}>Multimédia</option>
                            <option value="Vetements" {% if form.categorie.data == 'Vetements' %}selected{% endif %}>Vêtements</option>
                            <option value="Bijoux" {% if form.categorie.data == 'Bijoux' %}selected{% endif %}>Bijoux</option>
                            <option value="Loisirs" {% if form.categorie.data == 'Loisirs' %}selected{% endif %}>Loisirs</option>
                            <option value="Vaisselle" {% if form.categorie.data == 'Vaisselle' %}selected{% endif %}>Vaisselle</option>
                            <option value="Outillage" {% if form.categorie.data == 'Outillage' %}selected{% endif %}>Outillage</option>
                            <option value="Autre" {% if form.categorie.data == 'Autre' %}selected{% endif %}>Autre</option>
                        </select>
                        
                        {% if form.categorie.errors %}
                            {% for error in form.categorie.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="form-group {% if form.date_achat.errors %}has-error{% endif %}">
                        {{ form.date_achat.label(class="form-label") }}
                        {{ form.date_achat(class="form-input", type="date") }}
                        
                        {% if form.date_achat.errors %}
                            {% for error in form.date_achat.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="logement_id" class="form-label">Logement</label>
                        <select name="logement_id" id="logement_id" class="form-input" required>
                            <option value="" disabled {% if not form.logement_id.data and not ns.target_logement_id and not request.args.get('logement_id') %}selected{% endif %}>Sélectionner un logement</option>
                            {% for logement in liste_logement %}
                                <option value="{{ logement.id }}" {% if (form.logement_id.data and form.logement_id.data|string == logement.id|string) or (not form.logement_id.data and ((ns.target_logement_id and ns.target_logement_id|string == logement.id|string) or (request.args.get('logement_id') == logement.id|string))) %}selected{% endif %}>{{ logement.nom or logement.adresse }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="piece_id" class="form-label">Pièce</label>
                        <select name="piece_id" id="piece_id" class="form-input" required {% if not target_piece_id %}disabled{% endif %}>
                            <option value="" disabled {% if not target_piece_id %}selected{% endif %}>Sélectionner d'abord un logement</option>
                            {% for piece in liste_pieces %}
                                <option value="{{ piece.id }}" data-logement-id="{{ piece.id_logement }}" class="piece-option" {% if target_piece_id and piece.id|string == target_piece_id|string %}selected{% endif %}>
                                    {{ piece.nom_piece }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group {% if form.facture.errors %}has-error{% endif %}">
                        {{ form.facture.label(class="form-label") }}
                        {{ form.facture(class="form-input-file", required=True) }}
                        <small class="form-text" style="color: #d9534f;">* Justificatif obligatoire (PDF, JPG, PNG).</small>
                        
                        {% if form.facture.errors %}
                            {% for error in form.facture.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="form-actions">
                        {{ form.submit(class="btn-primary") }}
                        <a href="{{ url_for('tableau_de_bord') }}" class="btn-secondary">Annuler</a>
                    </div>
                </form>
            </div>
        </section>
    </main>
</div> 

<script src="{{ url_for('static', filename='js/ajouter_bien.js') }}"></script>
{% endblock %}