{% extends "base.html" %}

{% block title %}Déclarer un sinistre{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/declarer_sinistre.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <main class="main-content">
        <header>
            <h1>Déclarer un sinistre</h1>
            <p>Signalez un sinistre et calculez la valeur estimée de vos biens à indemniser</p>
        </header>

        <form action="{{ url_for('declarer_sinistre') }}" method="POST" class="sinistre-form">
            {{ form.hidden_tag() }}

            <section class="form-section">
                <div class="info-cards">
                    <div class="info-card">
                        <div class="card-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-blue">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <path d="M16 2v4M8 2v4M3 10h18"/>
                            </svg>
                            <label class="card-label">Date de sinistre</label>
                        </div>
                        <div class="card-input">
                            {{ form.date_sinistre(class="date-input", placeholder="jj / mm / aaaa") }}
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="card-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-orange">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <label class="card-label">Type de sinistre</label>
                        </div>
                        <div class="card-input">
                            {{ form.type_sinistre(class="select-input") }}
                        </div>
                    </div>
                </div>

                <div class="info-card" style="width: 100%; margin-top: 1.5rem;">
                    <div class="card-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-blue">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <label class="card-label">Description / Commentaire</label>
                    </div>
                    <div class="card-input">
                        {{ form.description(class="select-input", style="width: 100%; height: auto; min-height: 100px; padding: 10px;", rows="4", placeholder="Décrivez les circonstances du sinistre...") }}
                    </div>
                </div>
            </section>

            <section class="biens-section">
                <h2>Biens endommagés</h2>
                <p class="section-subtitle">Sélectionnez les biens affectés par le sinistre</p>

                <div class="filter-row">
                    <div class="filter-group">
                        <label>Résidence</label>
                        <select id="filter-residence" class="filter-select" name="logement_id" required>
                            <option value="">Sélectionner</option>
                            {% for logement in logements %}
                                <option value="{{ logement.id_logement }}">{{ logement.nom_logement or logement.adresse }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Pièce</label>
                        <select id="filter-piece" class="filter-select">
                            <option value="">Sélectionner</option>
                            {% for piece in pieces %}
                                <option value="{{ piece.id_piece }}">{{ piece.nom_piece }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table class="biens-table">
                        <thead>
                            <tr>
                                <th>Sélection</th>
                                <th>Nom du bien</th>
                                <th>Valeur</th>
                                <th>État du bien</th>
                            </tr>
                        </thead>
                        <tbody id="biens-tbody">
                            {% for bien in biens %}
                            <tr data-residence="{{ bien.piece.id_logement }}" data-piece="{{ bien.id_piece }}">
                                <td>
                                    <input type="checkbox" name="biens_selectionnes" value="{{ bien.id_bien }}" class="checkbox-bien" data-valeur="{{ bien.valeur_actuelle }}">
                                </td>
                                <td>{{ bien.nom_bien }}</td>
                                <td>{{ "%.2f"|format(bien.valeur_actuelle) }}€</td>
                                <td>
                                    <select name="etat_bien_{{ bien.id_bien }}" class="etat-select">
                                        <option value="perte_totale">Perte totale</option>
                                        <option value="perte_partielle">Perte partielle</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="biens-section" id="summary-section" style="display: none;">
                <h2>Récapitulatif des pertes</h2>
                <div class="table-container">
                    <table class="biens-table">
                        <thead>
                            <tr>
                                <th>Nom du bien</th>
                                <th>Valeur</th>
                                <th>État</th>
                                <th>Indemnisation</th>
                            </tr>
                        </thead>
                        <tbody id="summary-tbody"></tbody>
                    </table>
                </div>
            </section>

            <section class="footer-section">
                <div class="total-card">
                    <span class="total-label">Total à indemniser :</span>
                    <span class="total-value" id="total-indemnisation">0€</span>
                </div>

                <button type="submit" class="btn-primary">
                    Générer l'état financier des biens
                </button>
            </section>
        </form>
    </main>
</div>

<script> // Fais avec l'aide de l'IA
document.addEventListener('DOMContentLoaded', function() {
    const residenceSelect = document.getElementById('filter-residence');
    const pieceSelect = document.getElementById('filter-piece');
    const rows = document.querySelectorAll('#biens-tbody tr');
    const totalDisplay = document.getElementById('total-indemnisation');
    const checkboxes = document.querySelectorAll('.checkbox-bien');
    const etatSelects = document.querySelectorAll('.etat-select');
    const summarySection = document.getElementById('summary-section');
    const summaryTbody = document.getElementById('summary-tbody');
    let isDirty = false;

    // Détection des modifications pour l'alerte de sortie
    document.querySelector('.sinistre-form').addEventListener('change', () => isDirty = true);
    document.querySelector('.sinistre-form').addEventListener('submit', () => isDirty = false);
    
    window.addEventListener('beforeunload', (e) => {
        if (isDirty) {
            e.preventDefault();
            e.returnValue = "Vous avez commencé une déclaration. Si vous quittez, vos données seront perdues.";
        }
    });

    function filterBiens() {
        const residenceId = residenceSelect.value;
        const pieceId = pieceSelect.value;

        rows.forEach(row => {
            const rowResidence = row.dataset.residence;
            const rowPiece = row.dataset.piece;

            let show = true;
            if (residenceId && rowResidence !== residenceId) show = false;
            if (pieceId && rowPiece !== pieceId) show = false;

            row.style.display = show ? '' : 'none';
        });
    }

    function calculateTotal() {
        let total = 0;
        let summaryHTML = '';

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const row = checkbox.closest('tr');
                const valeur = parseFloat(checkbox.dataset.valeur) || 0;
                const etatSelect = row.querySelector('.etat-select');
                const etat = etatSelect.value;
                const indemnisation = (etat === 'perte_totale') ? valeur : valeur * 0.5;
                
                total += indemnisation;

                summaryHTML += `<tr>
                    <td>${row.cells[1].textContent}</td>
                    <td>${row.cells[2].textContent}</td>
                    <td>${etatSelect.options[etatSelect.selectedIndex].text}</td>
                    <td>${indemnisation.toFixed(2)}€</td>
                </tr>`;
            }
        });
        summaryTbody.innerHTML = summaryHTML;
        summarySection.style.display = summaryHTML ? 'block' : 'none';
        totalDisplay.textContent = total.toFixed(2) + '€';
    }

    residenceSelect.addEventListener('change', filterBiens);
    pieceSelect.addEventListener('change', filterBiens);
    checkboxes.forEach(cb => cb.addEventListener('change', calculateTotal));
    etatSelects.forEach(select => select.addEventListener('change', calculateTotal));
});
</script>
{% endblock %}