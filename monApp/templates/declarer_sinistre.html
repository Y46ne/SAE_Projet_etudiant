{% extends "base.html" %}

{% block title %}Déclarer un sinistre{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/declarer_sinistre.css') }}">
  <style>
      /* Petit ajout pour que le select devienne aussi rouge si erreur, 
         car votre CSS actuel ne cible que 'input' */
      .has-error input, .has-error select, .has-error textarea {
          border-color: #e74c3c !important;
      }
  </style>
{% endblock %}

{% block content %}
<div class="container">
    <main class="main-content">
        <header>
            <h1>Déclarer un sinistre</h1>
            <p>Signalez un sinistre et calculez la valeur estimée de vos biens à indemniser</p>
        </header>

        <form action="{{ url_for('declarer_sinistre') }}" method="POST" class="sinistre-form">
            {{ form.hidden_tag() }}

            <section class="form-section">
                <div class="info-cards">
                    
                    <div class="info-card">
                        <div class="card-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-blue">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <path d="M16 2v4M8 2v4M3 10h18"/>
                            </svg>
                            <label class="card-label">Date de sinistre</label>
                        </div>
                        <div class="card-input {% if form.date_sinistre.errors %}has-error{% endif %}">
                            {{ form.date_sinistre(class="date-input", placeholder="jj / mm / aaaa") }}
                            
                            {% if form.date_sinistre.errors %}
                                {% for error in form.date_sinistre.errors %}
                                    <span class="form-error">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="card-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-orange">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <label class="card-label">Type de sinistre</label>
                        </div>
                        <div class="card-input {% if form.type_sinistre.errors %}has-error{% endif %}">
                            {{ form.type_sinistre(class="select-input") }}
                            
                            {% if form.type_sinistre.errors %}
                                {% for error in form.type_sinistre.errors %}
                                    <span class="form-error">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="info-card" style="width: 100%; margin-top: 1.5rem;">
                    <div class="card-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-blue">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <label class="card-label">Description / Commentaire</label>
                    </div>
                    <div class="card-input {% if form.description.errors %}has-error{% endif %}">
                        {{ form.description(class="select-input", style="width: 100%; height: auto; min-height: 100px; padding: 10px;", rows="4", placeholder="Décrivez les circonstances du sinistre...") }}
                        
                        {% if form.description.errors %}
                            {% for error in form.description.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </section>

            <section class="biens-section">
                <h2>Biens endommagés</h2>
                <p class="section-subtitle">Sélectionnez les biens affectés par le sinistre</p>

                <div class="filter-row">
                    <div class="filter-group">
                        <label>Résidence</label>
                        <select id="filter-residence" class="filter-select" name="logement_id" required>
                            <option value="" disabled selected>Sélectionner un logement</option>
                            {% for logement in logements %}
                                <option value="{{ logement.id_logement }}">{{ logement.nom_logement or logement.adresse }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Pièce</label>
                        <select id="filter-piece" class="filter-select" disabled>
                            <option value="">Toutes les pièces</option>
                            {% for piece in pieces %}
                                <option value="{{ piece.id_piece }}" data-logement="{{ piece.id_logement }}">
                                    {{ piece.nom_piece }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table class="biens-table">
                        <thead>
                            <tr>
                                <th>Sélection</th>
                                <th>Nom du bien</th>
                                <th>Valeur</th>
                                <th>État du bien</th>
                            </tr>
                        </thead>
                        <tbody id="biens-tbody">
                            {% for bien in biens %}
                            <tr data-residence="{{ bien.piece.id_logement }}" data-piece="{{ bien.id_piece }}" style="display: none;">
                                <td>
                                    <input type="checkbox" name="biens_selectionnes" value="{{ bien.id_bien }}" class="checkbox-bien" data-valeur="{{ bien.valeur_actuelle }}">
                                </td>
                                <td>{{ bien.nom_bien }}</td>
                                <td>{{ "%.2f"|format(bien.valeur_actuelle) }}€</td>
                                <td>
                                    <select name="etat_bien_{{ bien.id_bien }}" class="etat-select">
                                        <option value="perte_totale">Perte totale</option>
                                        <option value="perte_partielle">Perte partielle</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="biens-section" id="summary-section" style="display: none;">
                <h2>Récapitulatif des pertes</h2>
                <div class="table-container">
                    <table class="biens-table">
                        <thead>
                            <tr>
                                <th>Nom du bien</th>
                                <th>Valeur</th>
                                <th>État</th>
                                <th>Indemnisation</th>
                            </tr>
                        </thead>
                        <tbody id="summary-tbody"></tbody>
                    </table>
                </div>
            </section>

            <section class="footer-section">
                <div class="total-card">
                    <span class="total-label">Total à indemniser :</span>
                    <span class="total-value" id="total-indemnisation">0€</span>
                </div>

                <button type="submit" class="btn-primary">
                    Générer l'état financier des biens
                </button>
            </section>
        </form>
    </main>
</div>

<script src="{{ url_for('static', filename='js/declarer_sinistre.js') }}"></script>
{% endblock %}