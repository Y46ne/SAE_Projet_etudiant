{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/logement_piece_bien.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
<div class="p-8">

{% if not current_user.is_assureur %}
<a href="{{ url_for('mes_logements') }}"
 class="btn btn-danger">
   ← Retour aux logements
</a>
{% else %}
<a href="{{ url_for('detail_assure', id=logement.assures[0].id_assure) }}"
 class="btn btn-danger">
   ← Retour au détail du client
</a>
{% endif %}

<div class="logement-details-header">
    <h1 class="text-2xl font-bold text-gray-800 mb-2">
        {{ logement.nom_logement }}
    </h1>
    <p class="text-gray-600 mb-1"><strong>Adresse :</strong> {{ logement.adresse }}</p>
    <p class="text-gray-600 mb-4"><strong>Nombre de pièces :</strong> {{ logement.pieces|length }}</p>

    {% if current_user.is_authenticated %}
    {% if not current_user.is_assureur %}

    <a href="{{ url_for('ajouter_piece', logement_id=logement.id_logement) }}" class="btn btn-success mb-3">Ajouter une pièce</a>
    {% endif %}
    {% endif %}

</div>



<div class="search-filter">
    <input type="text" id="searchPieces" placeholder="Rechercher une pièce...">
</div>

<table id="piecesTable" class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>Nom de la pièce</th>
            <th>Surface</th>
            <th>Nombre de biens</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for piece in logement.pieces %}
        <tr>
            <td>{{ piece.nom_piece }}</td>
            <td>{{ piece.surface or "-" }}</td>
            <td>{{ piece.biens|length }}</td>
            <td>
                <div class="task-controls">
                <a href="{{ url_for('gestion_bien', piece_id=piece.id_piece) }}" title="Voir les biens" class="btn btn-info">Voir biens<i class="fas fa-eye"></i></a>
                {% if not current_user.is_assureur %}
                <a href="{{ url_for('ajouter_bien', piece_id=piece.id_piece) }}" class="btn btn-info" title="Ajouter un bien">Ajouter bien<i class="fas fa-plus"></i></a>
                <a href="{{ url_for('modifier_piece', piece_id=piece.id_piece) }}" class="btn btn-warning">Modifier</a>
                <form action="{{ url_for('supprimer_piece', piece_id=piece.id_piece) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette pièce ? Cela supprimera également tous les biens associés.');">
                        Supprimer
                    </button>
                </form>
                {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{{ url_for('mes_logements') }}" class="btn btn-secondary mt-3">Retour</a>
</div>

<script src="{{ url_for('static', filename='js/searchTable.js') }}"></script>
<script>
    // Attend que le contenu du DOM soit entièrement chargé avant d'exécuter le script
    document.addEventListener('DOMContentLoaded', function() {
        // Appelle la fonction setupTableSearch avec l'ID de l'input de recherche et l'ID de la table
        setupTableSearch('searchInput', 'piecesTable');
    });
</script>
{% endblock %}